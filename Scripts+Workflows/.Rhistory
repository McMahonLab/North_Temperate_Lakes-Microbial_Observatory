install.packages(file.choose(), repo=NULL)
library(OTUtable)
if(!require(vegan)){
install.packages("vegan")
library(vegan)
}
if(!require(ggplot2)){
install.packages("ggplot2")
library(ggplot2)
}
if(!require(reshape2)){
install.packages("reshape2")
library(reshape2)
}
if(!require(RColorBrewer)){
install.packages("RColorBrewer")
library(RColorBrewer)
}
#Load data from package OTUtable
data(otu_table)
data(taxonomy)
data(metadata)
#Make tables at the clade and phylum level
clade_table <- combine_otus("Clade", otu_table, taxonomy)
phylum_table <- combine_otus("Phylum", otu_table, taxonomy)
#Report only last classified taxonomy level of group names
clade_table <- reduce_names(clade_table)
phylum_table <- reduce_names(phylum_table)
totals <- rowSums(phylum_table)
totals <- sort(totals)
#Remove the "p__" phylum designation from phylum names. This looks better for plotting.
get.names <- strsplit(names(totals), "p__")
phyla.names <- c()
for(i in 1:length(get.names)){
phyla.names[i] <- get.names[[i]][2]
}
phyla.names[which(is.na(phyla.names) == T)] <- "unclassified"
#Set up a dataframe for plotting in ggplot2. Set the phyla.names to factors, with levels in order of abundance.
phylum_totals <- data.frame(phyla.names, totals)
phylum_totals$phyla.names <- factor(phylum_totals$phyla.names, levels = phylum_totals$phyla.names[order(phylum_totals$totals)])
ggplot(data=phylum_totals, aes(x = phyla.names, y = totals)) + geom_bar(stat = "identity", fill = "grey", colour="black") + labs(x = NULL, y = "Log of Observed Reads") + theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 15, vjust=1.2), plot.title = element_text(size = 20), axis.text.y = element_text(colour="black")) + scale_y_log10(expand = c(0,0)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))
#Specify the sampled layers
layer <- c("CBE", "FBE", "WSE", "NSE", "TBE", "SSE", "HKE", "MAE", "CBH", "FBH", "WSH", "NSH", "TBH",  "SSH", "HKH", "MAH")
#Set up a dataframe with the totals of each phylum for each sampling site
layer.phyla <- rep(NA, dim(phylum_table)[1])
for(i in 1:length(layer)){
dataset <- bog_subset(layer[i], phylum_table)
layer.phyla <- cbind(layer.phyla, rowSums(dataset))
}
layer.phyla <- layer.phyla[,2:dim(layer.phyla)[2]]
colnames(layer.phyla) <- layer
#Combine low abundance phyla into a single category called "other"
abun <- layer.phyla[which(rowSums(layer.phyla) >= 10000),]
other <- layer.phyla[which(rowSums(layer.phyla) < 10000),]
new.layer <- rbind(abun, colSums(other))
#Shorten up those names again and remove extraneous rownames
get.names <- strsplit(rownames(new.layer), "p__")
phyla.names <- c()
for(i in 1:length(get.names)){
phyla.names[i] <- get.names[[i]][2]
}
phyla.names[7] <- "unclassifed"
phyla.names[12] <- "other"
phyla.names <- factor(phyla.names, levels=rev(phyla.names))
rownames(new.layer) <- NULL
#Convert data into a long format dataframe for use in ggplot
phyla_by_bog <- data.frame(phyla.names, new.layer)
phyla_by_bog2 <- melt(phyla_by_bog)
clade_table07 <- year_subset("07", clade_table)
all.hypo <- bog_subset("..H", clade_table07)
TBH <- bog_subset("TBH", all.hypo)
MAH <- bog_subset("MAH", all.hypo)
#Label which lake each sample comes from
groups <- c(rep("Trout", dim(TBH)[2]), rep("Mary", dim(MAH)[2]))
input <- cbind(TBH, MAH)
dates <- extract_date(colnames(input))
#Remove January samples
dates <- dates[c(1:32, 35:130)]
input <- input[,c(1:32, 35:130)]
groups <- groups[c(1:32, 35:130)]
#Run PCoA using Bray-Curtis Similarity as distance metric
distance <- vegdist(t(input), method="bray")
pcoa <- betadisper(distance, groups)
#Extract scores for plotting
scores <- scores(pcoa)
#Make dataframe for plotting
plot.pcoa <- data.frame(groups, as.numeric(dates - dates[78]), scores)
colnames(plot.pcoa) <- c("Lake", "Date", "PCoA1", "PCoA2")
pdf(file = "C:/Users/amlinz16/Dropbox/Deblurred Bog Tags/Bog_paper_figures_and_scripts/Figures Nov15/TBH_v_MAH_PCoA.pdf", width = 3.3125*2, height = 4.625, useDingbats=FALSE)
pdf(file = "C:/Users/amlinz16/Dropbox/Deblurred Bog Tags/Bog_paper_figures_and_scripts/Figures Nov15/TBH_v_MAH_PCoA.pdf", width = 3.3125*2, height = 4.625, useDingbats=FALSE)
pdf(file = "C:/Users/amlinz16/Dropbox/Deblurred Bog Tags/Bog_paper_figures_and_scripts/Figures Nov15/TBH_v_MAH_PCoA.pdf", width = 3.3125*2, height = 4.625, useDingbats=FALSE)
pdf(file = "C:/Users/Alex/Dropbox/Deblurred Bog Tags/Bog_paper_figures_and_scripts/Figures Nov15/TBH_v_MAH_PCoA.pdf", width = 3.3125*2, height = 4.625, useDingbats=FALSE)
ggplot(data=plot.pcoa, aes(x = PCoA1, y = PCoA2, shape = Lake, color = Date)) + geom_point(size=3) + scale_shape_discrete(solid=T) + scale_colour_gradient2(low = "white", mid = "yellow", high = "red") + geom_point(size=4) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 15, vjust=0.7), axis.text.y = element_text(colour="black", size=12))
dev.off()
named_otu_table <- otu_table
fullnames <- c()
for(i in 1:dim(taxonomy)[1]){
fullnames[i] <- paste(taxonomy[i,], collapse = ";")
}
fullnames <- make.unique(fullnames)
rownames(named_otu_table) <- fullnames
#Re-run clade and phylum tables so that names are no longer shortened.
clade_table <- combine_otus("Clade", otu_table, taxonomy)
phylum_table <- combine_otus("Phylum", otu_table, taxonomy)
#Combine the tables at all taxonomic levels into one giant table
full_table <- rbind(named_otu_table, tribe_table, clade_table, lineage_table, order_table, class_table, phylum_table)
#Remove unclassified groups - I'm not interested in these for this analysis
classified <- grep("unclassified", rownames(full_table))
classified1 <- grep("__$", rownames(full_table))
parsed_table <- full_table[-c(classified, classified1),]
#Identify mixing dates
metadata$Sample_Name <- as.character(metadata$Sample_Name)
metalakes <- substr(metadata$Sample_Name, start=1, stop=3)
metayears <- substr(metadata$Sample_Name, start=9, stop=10)
metaTBH <- metadata[which(metalakes == "TBH"), c(1,2,4)]
metaTBH <- dcast(metaTBH, Sample_Name~Depth, fun.aggregate=mean)
TBHmixes <- metaTBH$Sample_Name[which(metaTBH$"0.5" - metaTBH$"7" < 1)]
metaNSH <- metadata[which(metalakes == "NSH"), c(1,2,4)]
metaNSH <- dcast(metaNSH, Sample_Name~Depth, fun.aggregate=mean)
NSHmixes <- metaNSH$Sample_Name[which(metaNSH$"0.5" - metaNSH$"4" < 1)]
metaSSH <- metadata[which(metalakes == "SSH"), c(1,2,4)]
metaSSH <- dcast(metaSSH, Sample_Name~Depth, fun.aggregate=mean)
SSHmixes <- metaSSH$Sample_Name[which(metaSSH$"0.5" - metaSSH$"8" < 1)]
metaCBH <- metadata[which(metalakes == "CBH"), c(1,2,4)]
metaCBH <- dcast(metaCBH, Sample_Name~Depth, fun.aggregate=mean)
CBHmixes <- metaCBH$Sample_Name[which(metaCBH$"0.5" - metaCBH$"2" < 1)]
metaWSH <- metadata[which(metalakes == "WSH"), c(1,2,4)]
metaWSH <- dcast(metaWSH, Sample_Name~Depth, fun.aggregate=mean)
WSHmixes <- metaWSH$Sample_Name[which(metaWSH$"0.5" - metaWSH$"4" < 1)]
metaFBH <- metadata[which(metalakes == "FBH"), c(1,2,4)]
metaFBH <- dcast(metaFBH, Sample_Name~Depth, fun.aggregate=mean)
FBHmixes <- metaFBH$Sample_Name[which(metaFBH$"0.5" - metaFBH$"1.5" < 1)]
mixes <- c(CBHmixes, FBHmixes, WSHmixes, TBHmixes, NSHmixes, SSHmixes)
input_table <- bog_subset("NSE|NSH|SS.|TB.|HK.|MA.", parsed_table)
mixing_dates <- match(mixes, substr(colnames(input_table), start=1, stop=10))
remove <- mixing_dates[which(is.na(mixing_dates) == F)]
input_table <- input_table[,-remove]
classified <- grep("unclassified", rownames(full_table))
classified1 <- grep("__$", rownames(full_table))
parsed_table <- full_table[-c(classified, classified1),]
full_table <- rbind(named_otu_table, tribe_table, clade_table, lineage_table, order_table, class_table, phylum_table)
tribe_table <- combine_otus("Tribe", otu_table, taxonomy)
clade_table <- combine_otus("Clade", otu_table, taxonomy)
lineage_table <- combine_otus("Lineage", otu_table, taxonomy)
order_table <- combine_otus("Order", otu_table, taxonomy)
class_table <- combine_otus("Class", otu_table, taxonomy)
phylum_table <- combine_otus("Phylum", otu_table, taxonomy)
clade_table07 <- year_subset("07", clade_table)
named_otu_table <- otu_table
fullnames <- c()
for(i in 1:dim(taxonomy)[1]){
fullnames[i] <- paste(taxonomy[i,], collapse = ";")
}
fullnames <- make.unique(fullnames)
rownames(named_otu_table) <- fullnames
full_table <- rbind(named_otu_table, tribe_table, clade_table, lineage_table, order_table, class_table, phylum_table)
classified <- grep("unclassified", rownames(full_table))
classified1 <- grep("__$", rownames(full_table))
parsed_table <- full_table[-c(classified, classified1),]
metadata$Sample_Name <- as.character(metadata$Sample_Name)
metalakes <- substr(metadata$Sample_Name, start=1, stop=3)
metayears <- substr(metadata$Sample_Name, start=9, stop=10)
metaTBH <- metadata[which(metalakes == "TBH"), c(1,2,4)]
metaTBH <- dcast(metaTBH, Sample_Name~Depth, fun.aggregate=mean)
TBHmixes <- metaTBH$Sample_Name[which(metaTBH$"0.5" - metaTBH$"7" < 1)]
metaNSH <- metadata[which(metalakes == "NSH"), c(1,2,4)]
metaNSH <- dcast(metaNSH, Sample_Name~Depth, fun.aggregate=mean)
NSHmixes <- metaNSH$Sample_Name[which(metaNSH$"0.5" - metaNSH$"4" < 1)]
metaSSH <- metadata[which(metalakes == "SSH"), c(1,2,4)]
metaSSH <- dcast(metaSSH, Sample_Name~Depth, fun.aggregate=mean)
SSHmixes <- metaSSH$Sample_Name[which(metaSSH$"0.5" - metaSSH$"8" < 1)]
metaCBH <- metadata[which(metalakes == "CBH"), c(1,2,4)]
metaCBH <- dcast(metaCBH, Sample_Name~Depth, fun.aggregate=mean)
CBHmixes <- metaCBH$Sample_Name[which(metaCBH$"0.5" - metaCBH$"2" < 1)]
metaWSH <- metadata[which(metalakes == "WSH"), c(1,2,4)]
metaWSH <- dcast(metaWSH, Sample_Name~Depth, fun.aggregate=mean)
WSHmixes <- metaWSH$Sample_Name[which(metaWSH$"0.5" - metaWSH$"4" < 1)]
metaFBH <- metadata[which(metalakes == "FBH"), c(1,2,4)]
metaFBH <- dcast(metaFBH, Sample_Name~Depth, fun.aggregate=mean)
FBHmixes <- metaFBH$Sample_Name[which(metaFBH$"0.5" - metaFBH$"1.5" < 1)]
mixes <- c(CBHmixes, FBHmixes, WSHmixes, TBHmixes, NSHmixes, SSHmixes)
data(metadata)
data(otu_table)
input_table <- bog_subset("NSE|NSH|SS.|TB.|HK.|MA.", parsed_table)
mixing_dates <- match(mixes, substr(colnames(input_table), start=1, stop=10))
remove <- mixing_dates[which(is.na(mixing_dates) == F)]
input_table <- input_table[,-remove]
#Keep only groups with abundances in the top quantile (75th or higher)
threshold <- quantile(rowSums(input_table))[4]
input_table <- input_table[which(rowSums(input_table) >= threshold),]
#Format table for input into indicspecies analysis
input_table <- t(input_table)
input_table <- as.data.frame(input_table)
sampleids <- rownames(input_table)
layer <- substr(sampleids, start=3, stop=3)
layerid <- c("E", "H")
epi_v_hypo <- c()
for(i in 1:length(layerid)){
epi_v_hypo[which(layer == layerid[i])] <- i
}
#Run multipatt(), specifing the the index of choice is group-normalized correlation
clade_by_layer <- multipatt(x = input_table, cluster = epi_v_hypo, func = "r.g", control = how(nperm = 9999))
library(indicspecies)
sampleids <- rownames(input_table)
layer <- substr(sampleids, start=3, stop=3)
layerid <- c("E", "H")
epi_v_hypo <- c()
for(i in 1:length(layerid)){
epi_v_hypo[which(layer == layerid[i])] <- i
}
#Run multipatt(), specifing the the index of choice is group-normalized correlation
clade_by_layer <- multipatt(x = input_table, cluster = epi_v_hypo, func = "r.g", control = how(nperm = 9999))
results <- clade_by_layer$sign
hypo <- results[which(results$index == 2),]
hypo <- hypo[order(hypo$stat, decreasing=T),]
hypo.indicators <- hypo[c(1, 3, 4, 5, 6, 7, 10, 16, 17, 21), ]
hypo_table <- bog_subset("..H", t(input_table))
hits <- match(rownames(hypo.indicators), rownames(hypo_table))
hypo.indicators$abundance <- rowSums(hypo_table[hits,])/sum(rowSums(hypo_table)) * 100
rownames(hypo.indicators) <- substr(rownames(hypo.indicators), start=13, stop = 150)
hypo.indicators$groups <- factor(rownames(hypo.indicators), levels=rownames(hypo.indicators))
ggplot(data=hypo.indicators, aes(x=groups, y=abundance, fill=stat)) + geom_bar(stat="identity", colour="black") + coord_flip() + labs(x = NULL, y = "% of Community") + theme(axis.text.x = element_text(angle = 90, size = 6, colour = "black"), axis.title = element_text(size = 10, vjust=-0.5), axis.text.y = element_text(colour="black", size = 6), legend.text = element_text(size=6)) + scale_y_continuous(expand = c(0,0)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + scale_fill_gradient(low= "lightgrey", high= "black")
hypo.indicators
hypo.indicators
hypo <- hypo[order(hypo$stat, decreasing=T),]
hypo[1:40]
hypo[1:40,]
hypo.indicators <- hypo[c(1, 3, 4, 5, 6, 7, 10, 17, 21, 22), ]
hypo_table <- bog_subset("..H", t(input_table))
hits <- match(rownames(hypo.indicators), rownames(hypo_table))
hypo.indicators$abundance <- rowSums(hypo_table[hits,])/sum(rowSums(hypo_table)) * 100
rownames(hypo.indicators) <- substr(rownames(hypo.indicators), start=13, stop = 150)
hypo.indicators$groups <- factor(rownames(hypo.indicators), levels=rownames(hypo.indicators))
ggplot(data=hypo.indicators, aes(x=groups, y=abundance, fill=stat)) + geom_bar(stat="identity", colour="black") + coord_flip() + labs(x = NULL, y = "% of Community") + theme(axis.text.x = element_text(angle = 90, size = 6, colour = "black"), axis.title = element_text(size = 10, vjust=-0.5), axis.text.y = element_text(colour="black", size = 6), legend.text = element_text(size=6)) + scale_y_continuous(expand = c(0,0)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + scale_fill_gradient(low= "lightgrey", high= "black")
pdf(file = "C:/Users/Alex/Dropbox/Deblurred Bog Tags/Bog_paper_figures_and_scripts/Figures Nov15/Hypo_indicators.pdf", width = 3.3125*2, height = 4.625/2)
ggplot(data=hypo.indicators, aes(x=groups, y=abundance, fill=stat)) + geom_bar(stat="identity", colour="black") + coord_flip() + labs(x = NULL, y = "% of Community") + theme(axis.text.x = element_text(angle = 90, size = 6, colour = "black"), axis.title = element_text(size = 10, vjust=-0.5), axis.text.y = element_text(colour="black", size = 6), legend.text = element_text(size=6)) + scale_y_continuous(expand = c(0,0)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + scale_fill_gradient(low= "lightgrey", high= "black")
dev.off()
library(OTUtable)
library(indicspecies)
data(otu_table)
data(taxonomy)
tribe_table <- combine_otus("Tribe", otu_table, taxonomy)
clade_table <- combine_otus("Clade", otu_table, taxonomy)
lineage_table <- combine_otus("Lineage", otu_table, taxonomy)
order_table <- combine_otus("Order", otu_table, taxonomy)
class_table <- combine_otus("Class", otu_table, taxonomy)
phylum_table <- combine_otus("Phylum", otu_table, taxonomy)
full_table <- rbind(otu_table, tribe_table, clade_table, lineage_table, order_table, class_table, phylum_table)
classified <- grep("unclassified", rownames(full_table))
classified1 <- grep("__$", rownames(full_table))
input_table <- full_table[-c(classified, classified1),]
lakeid <- c("CB", "FB", "WS", "NS", "TB", "SS", "HK","MA")
lakes <- substr(rownames(input_table), start=1, stop=2)
mixing_groups <- c()
mixing_groups[which(lakes == "CB" | lakes == "FB" | lakes == "WS")] <- 1
mixing_groups[which(lakes == "TB"| lakes == "NS"| lakes == "SS")] <- 2
mixing_groups[which(lakes == "MA" | lakes == "HK")] <- 3
clades_by_mixing <- multipatt(x = input_table, cluster = mixing_groups, func = "r.g", control = how(nperm = 9999))
mixing_groups
lakes
threshold <- quantile(rowSums(input_table))[4]
input_table <- input_table[which(rowSums(input_table) >= threshold),]
input_table <- t(input_table)
input_table <- as.data.frame(input_table)
lakes <- substr(rownames(input_table), start=1, stop=2)
mixing_groups <- c()
mixing_groups[which(lakes == "CB" | lakes == "FB" | lakes == "WS")] <- 1
mixing_groups[which(lakes == "TB"| lakes == "NS"| lakes == "SS")] <- 2
mixing_groups[which(lakes == "MA" | lakes == "HK")] <- 3
clades_by_mixing <- multipatt(x = input_table, cluster = mixing_groups, func = "r.g", control = how(nperm = 9999))
write.csv(clades_by_mixing$sign, file = "C:\Users\Alex\Desktop\North_Temperate_Lakes-Microbial_Observatory\Data\indicators_by_mixing.csv")
write.csv(clades_by_mixing$sign, file = "C:/Users/Alex/Desktop/North_Temperate_Lakes-Microbial_Observatory/Data/indicators_by_mixing.csv")
named_otu_table <- otu_table
fullnames <- c()
for(i in 1:dim(taxonomy)[1]){
fullnames[i] <- paste(taxonomy[i,], collapse = ";")
}
fullnames <- make.unique(fullnames)
rownames(named_otu_table) <- fullnames
full_table <- rbind(named_otu_table, tribe_table, clade_table, lineage_table, order_table, class_table, phylum_table)
classified <- grep("unclassified", rownames(full_table))
classified1 <- grep("__$", rownames(full_table))
input_table <- full_table[-c(classified, classified1),]
threshold <- quantile(rowSums(input_table))[4]
input_table <- input_table[which(rowSums(input_table) >= threshold),]
input_table <- t(input_table)
input_table <- as.data.frame(input_table)
lakeid <- c("CB", "FB", "WS", "NS", "TB", "SS", "HK","MA")
lakes <- substr(rownames(input_table), start=1, stop=2)
mixing_groups <- c()
mixing_groups[which(lakes == "CB" | lakes == "FB" | lakes == "WS")] <- 1
mixing_groups[which(lakes == "TB"| lakes == "NS"| lakes == "SS")] <- 2
mixing_groups[which(lakes == "MA" | lakes == "HK")] <- 3
clades_by_mixing <- multipatt(x = input_table, cluster = mixing_groups, func = "r.g", control = how(nperm = 9999))
write.csv(clades_by_mixing$sign, file = "C:/Users/Alex/Desktop/North_Temperate_Lakes-Microbial_Observatory/Data/indicators_by_mixing.csv")
dimictic <- c("NSH", "TBH", "SSH")
years <- c("05", "07", "08", "09")
library(reshape2)
library(OTUtable)
library(vegan)
data(otu_table)
data(taxonomy)
data(metadata)
clade_table <- combine_otus("Clade", otu_table, taxonomy)
metalakes <- substr(metadata$Sample_Name, start=1, stop=3)
metayears <- substr(metadata$Sample_Name, start=9, stop=10)
mary <- bog_subset("MAH", clade_table)
m <- matrix(NA, length(dimictic), length(years))
r <- matrix(NA, length(dimictic), length(years))
n <- matrix(NA, length(dimictic), length(years))
b <- matrix(NA, length(dimictic), length(years))
p <- matrix(NA, length(dimictic), length(years))
for(i in 1:length(dimictic)){
bog <- bog_subset(dimictic[i], clade_table)
for(j in 1:length(years)){
mary.year <- year_subset(years[j], mary)
data <- year_subset(years[j], bog)
metabog <- metadata[which(metalakes == dimictic[i] & metayears == years[j]), c(1,2,4)]
if(dim(data)[2] > 0){
metabog2 <- dcast(metabog, Sample_Name~Depth, fun.aggregate=mean)
mixes <- extract_date(metabog2$Sample_Name[which(metabog2$"0.5" - metabog2[,dim(metabog2)[2]-1] < 1)])
bogdates <- extract_date(colnames(data))
parsed.data <- data[,which(is.na(match(bogdates, mixes)) == T)]
parsed.dates <- extract_date(colnames(parsed.data))
parsed.data <- parsed.data[,order(parsed.dates)]
final.dates <- extract_date(colnames(parsed.data))
mean.bc <- c()
for(k in 1:dim(parsed.data)[2]){
bc.dis <- c()
for(l in 1:dim(mary.year)[2]){
test <- cbind(parsed.data[,k], mary.year[,l])
bc.dis[l] <- 1 - vegdist(t(test), method="bray")
}
mean.bc[k] <- mean(bc.dis)
}
time <- as.numeric(final.dates - final.dates[1])
r[i,j] <- cor(time, mean.bc)
n[i,j] <- length(mean.bc)
bestfit <- lm(mean.bc ~ time)
m[i,j] <- bestfit$coefficients[2]
b[i,j] <- bestfit$coefficients[1]
p[i,j] <- summary(bestfit)$coefficients[2,4]
}
}
}
colnames(m) <- years
colnames(r) <- years
colnames(p) <- years
colnames(b) <- years
rownames(m) <- dimictic
rownames(r) <- dimictic
rownames(p) <- dimictic
rownames(b) <- dimictic
m
r
p
b
