---
title: "Supplemental Figures"
author: "Alexandra Linz"
date: "Monday, December 07, 2015"
output: pdf_document
---
###Supplemental figures accompanying the paper "Seasonal mixing frequency and historical mixing regime determine hypolimnion bacterial community dynamics in bog lakes"

```{r, Setting_up_the_environoment, echo=F, warning=FALSE, message=FALSE}

library(OTUtable)

if(!require(vegan)){
    install.packages("vegan")
    library(vegan)
 }

if(!require(ggplot2)){
    install.packages("ggplot2")
    library(ggplot2)
 }

if(!require(reshape2)){
    install.packages("reshape2")
    library(reshape2)
 }

if(!require(RColorBrewer)){
    install.packages("RColorBrewer")
    library(RColorBrewer)
}

#Load data from package OTUtable
data(otu_table)
data(taxonomy)
data(metadata)

#Make tables at the clade and phylum level
clade_table <- combine_otus("Clade", otu_table, taxonomy)
phylum_table <- combine_otus("Phylum", otu_table, taxonomy)

#Report only last classified taxonomy level of group names
clade_table <- reduce_names(clade_table)
phylum_table <- reduce_names(phylum_table)

```

```{r, Rank_abundance:epilimnia, echo=FALSE, warning=FALSE, message=FALSE}
#Keep only epilimnion samples
epi_clade_table <- bog_subset("..E", clade_table)

#Remove taxonomic level tags at the beginning of some names (present in Greengenes classified clades)
get.names <- strsplit(rownames(epi_clade_table), "__")
epi.clade.names <- c()
for(i in 1:length(get.names)){
  if(length(get.names[[i]]) == 2){
  epi.clade.names[i] <- get.names[[i]][2]
  }else{
    epi.clade.names[i] <- rownames(epi_clade_table)[i]
  }
}
#Make trimmed taxonomies the new rownames - some duplicates, so make.unique() is needed. Adds .1, .2, etc to end of duplicate names
rownames(epi_clade_table) <- make.unique(epi.clade.names)

#Sum total abundances of epilimnion clades
epi_clade_sums <- sort(rowSums(epi_clade_table), decreasing = T)

#Make dataframe of the 20 most abundant epilimnion clades for plotting
plot_epi_clades <- data.frame(names(epi_clade_sums)[1:20], epi_clade_sums[1:20])
colnames(plot_epi_clades) <- c("Clade", "Abundance")
plot_epi_clades$Clade <- factor(plot_epi_clades$Clade, levels=plot_epi_clades$Clade)
ggplot(data=plot_epi_clades, aes(x=Clade, y=Abundance)) + geom_bar(stat = "identity", fill = "grey", colour="black") + labs(x = NULL, y = "Observed Reads in Epilimnia") + theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 12, vjust=2), axis.text.y = element_text(colour="black")) + scale_y_continuous(expand = c(0,0)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

####Figure S1. Rank abundance of the 20 most abundant clades in epilimnia samples. Total reads in all epilimnion samples have been summed for each clade-level group. Names represent the last classified level of taxonomic information for that clade; for example, the designation "Bacteria" indicates that clades unclassified at the phylum level are the fifth most abundant group in these samples. The most abundant groups in epilimnia are Pnec, acI-B, betI-A, and bacI-A. 
***
```{r, Rank_abundance:hypolimnia, echo=FALSE, warning=FALSE, message=FALSE}
#Repeat the same analysis as above on hypolimnion samples, but remove samples where the water column was mixed, as well as all polymictic lake samples.
#I use the metadata file to find samples from mixed days. I define a mixed day as less than 1 degree of temperature difference between 0.5 meters and the maximum sampling depth.

metadata$Sample_Name <- as.character(metadata$Sample_Name)
metalakes <- substr(metadata$Sample_Name, start=1, stop=3)
metayears <- substr(metadata$Sample_Name, start=9, stop=10)

#Identify mixed dates from dimictic lakes
metaTBH <- metadata[which(metalakes == "TBH" & metayears == "07"), c(1,2,4)]
metaTBH <- dcast(metaTBH, Sample_Name~Depth, fun.aggregate=mean)
TBHmixes <- metaTBH$Sample_Name[which(metaTBH$"0.5" - metaTBH$"7" < 1)]

metaNSH <- metadata[which(metalakes == "NSH" & metayears == "07"), c(1,2,4)]
metaNSH <- dcast(metaNSH, Sample_Name~Depth, fun.aggregate=mean)
NSHmixes <- metaNSH$Sample_Name[which(metaNSH$"0.5" - metaNSH$"4" < 1)]

metaSSH <- metadata[which(metalakes == "SSH" & metayears == "07"), c(1,2,4)]
metaSSH <- dcast(metaSSH, Sample_Name~Depth, fun.aggregate=mean)
SSHmixes <- metaSSH$Sample_Name[which(metaSSH$"0.5" - metaSSH$"8" < 1)]

mixes <- c(TBHmixes, NSHmixes, SSHmixes)

#Remove mixed dates from table of dimictic and meromictic hypolimnion samples
hypo_clade_table <- bog_subset("TBH|SSH|NSH|MAH|HKH", clade_table)
hits <- match(mixes, substr(colnames(hypo_clade_table), start = 1, stop = 10))
hypo_clade_table <- hypo_clade_table[,-hits]

#Remove tag indicating taxonomy level from rownames
get.names <- strsplit(rownames(hypo_clade_table), "__")
hypo.clade.names <- c()
for(i in 1:length(get.names)){
  if(length(get.names[[i]]) == 2){
  hypo.clade.names[i] <- get.names[[i]][2]
  }else{
    hypo.clade.names[i] <- rownames(hypo_clade_table)[i]
  }
}
rownames(hypo_clade_table) <- make.unique(hypo.clade.names)

#Plot rank abundance curve for 20 most abundant hypolimnion clades
hypo_clade_sums <- sort(rowSums(hypo_clade_table), decreasing = T)
plot_hypo_clades <- data.frame(names(hypo_clade_sums)[1:20], hypo_clade_sums[1:20])
colnames(plot_hypo_clades) <- c("Clade", "Abundance")
plot_hypo_clades$Clade <- factor(plot_hypo_clades$Clade, levels=plot_hypo_clades$Clade)
ggplot(data=plot_hypo_clades, aes(x=Clade, y=Abundance)) + geom_bar(stat = "identity", fill = "grey", colour="black") + labs(x = NULL, y = "Observed Reads in Hypolimnia") + theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 12, vjust=2), axis.text.y = element_text(colour="black")) + scale_y_continuous(expand = c(0,0)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

####Figure S2. Rank abundance of 20 most abundant clades in hypolimnia (mixed dates and polymictic lake samples removed). As in Fig. S1, clade names reflect the last classified taxonomic level; therefore, the clade labeled "Bacteria" represents all clades that could not be classified into a phylum. Pnec, unclassified *Bacteria*, *Geothrix*, and unclassified *Bacteroidetes* are the most abundant clades in hypolimnia.  
***
```{r, CoV:epilimnia, echo=FALSE, warning=FALSE, message=FALSE}
#Function to calculate coefficient of variance (standard deviation/mean)
CoV <- function(vector){
  sample <- as.numeric(vector)
  m <- mean(sample)
  s <- sd(sample)
  return(s/m)
}

#Sort epilimnion clades by abundance
sorted_epi_clade_table <- epi_clade_table[match(names(epi_clade_sums), rownames(epi_clade_table)),]
#Calculate CoV
Cov_epi <- apply(sorted_epi_clade_table, 1, CoV)

#Make dataframe of top 20 clades by abundance for plotting
plot_cov_epi <- data.frame(names(Cov_epi)[1:20], Cov_epi[1:20])
colnames(plot_cov_epi) <- c("Clade", "CoV")
plot_cov_epi$Clade <- factor(plot_cov_epi$Clade, levels=plot_cov_epi$Clade)
ggplot(data=plot_cov_epi, aes(x=Clade, y=CoV)) + geom_bar(stat = "identity", fill = "grey", colour="black") + labs(x = NULL, y = "CoV in Epilimnia") + theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 12, vjust=2), axis.text.y = element_text(colour="black")) + scale_y_continuous(expand = c(0,0)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

####Figure S3. Coefficient of Variance for the top 20 clades in epilimnia. A low CoV indicates low varability in abundance, while a high CoV indicates high variability in abundance. In epilimnia, some of the most abundant clades (Pnec, acI-B, betI-A, and bacI-A) have low CoV values, while *Cyanobacteria*, gamI, and *Geothrix* have high CoV values, indicating more variability in their abundance measurements. 
***
```{r, CoV: hypolimnia, echo=FALSE, warning=FALSE, message=FALSE}
#Repeat above analysis for hypo
sorted_hypo_clade_table <- hypo_clade_table[match(names(hypo_clade_sums), rownames(hypo_clade_table)),]
Cov_hypo <- apply(sorted_hypo_clade_table, 1, CoV)
plot_cov_hypo <- data.frame(names(Cov_hypo)[1:20], Cov_hypo[1:20])
colnames(plot_cov_hypo) <- c("Clade", "CoV")
plot_cov_hypo$Clade <- factor(plot_cov_hypo$Clade, levels=plot_cov_hypo$Clade)
ggplot(data=plot_cov_hypo, aes(x=Clade, y=CoV)) + geom_bar(stat = "identity", fill = "grey", colour="black") + labs(x = NULL, y = "CoV in hypolimnia") + theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 12, vjust=2), axis.text.y = element_text(colour="black")) + scale_y_continuous(expand = c(0,0)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

####Figure S4. Coefficient of variance for the top 20 clades in hypolimnia (mixing dates and polymictic lake samples removed). A low CoV indicates low varability in abundance, while a high CoV indicates high variability in abundance. In epilimnia, some of the most abundant clades (Pnec, unclassified Bacteria, Geothrix, and unclassified Bacteroidetes) have low CoV values, while gamIII-A has a very high CoV value, indicating more variability in its abundance measurements.   
***
```{r, CoV:hypolimnion+mixing, echo=FALSE, warning=FALSE, message=FALSE}
#Compute difference in CoV when mixing is included vs when it is not included in the hypolimnion analysis.

#Make clade table with mixing dates removed
hypo_clade_table <- bog_subset("TBH|SSH|NSH|MAH|HKH", clade_table)
hits <- match(mixes, substr(colnames(hypo_clade_table), start = 1, stop = 10))
hypo_clade_table <- hypo_clade_table[,-hits]

#Remove taxonomy level tags
get.names <- strsplit(rownames(hypo_clade_table), "__")
hypo.clade.names <- c()
for(i in 1:length(get.names)){
  if(length(get.names[[i]]) == 2){
  hypo.clade.names[i] <- get.names[[i]][2]
  }else{
    hypo.clade.names[i] <- rownames(hypo_clade_table)[i]
  }
}

rownames(hypo_clade_table) <- make.unique(hypo.clade.names)

#Make clade table of mixing dates only
w_mixing <- bog_subset("..H", clade_table)
hits <- match(mixes, substr(colnames(w_mixing), start = 1, stop = 10))
hits <- hits[which(is.na(hits) == F)]
w_mixing <- w_mixing[,hits]

get.names <- strsplit(rownames(w_mixing), "__")
mixing.clade.names <- c()
for(i in 1:length(get.names)){
  if(length(get.names[[i]]) == 2){
  mixing.clade.names[i] <- get.names[[i]][2]
  }else{
    mixing.clade.names[i] <- rownames(w_mixing)[i]
  }
}
rownames(w_mixing) <- make.unique(mixing.clade.names)

#Subtract CoV of mixing dates from CoV of no mixing dates
Cov_no_mixing <- apply(hypo_clade_table, 1, CoV)
Cov_w_mixing <- apply(w_mixing, 1, CoV)
diff <- Cov_no_mixing - Cov_w_mixing
diff.top <- diff[match(names(hypo_clade_sums)[1:20], names(diff))]

#Make dataframe for plotting
plot.diff <- data.frame(names(diff.top), diff.top)
colnames(plot.diff) <- c("Clade", "Covariance")
plot.diff$Clade <- factor(plot.diff$Clade, levels=plot.diff$Clade)
ggplot(data=plot.diff, aes(x=Clade, y=Covariance)) + geom_bar(stat = "identity", fill = "grey", colour="black") + labs(x = NULL, y = "Difference in CoV") + theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 12, vjust=2), axis.text.y = element_text(colour="black")) + scale_y_continuous(expand = c(0,0), limits = c(-2, 2)) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + geom_hline(aes(yintercept=0))
```

####Figure S5. Difference in the coefficient of variance for the top 20 clades between hypolimnia (mixing dates and polymictic lake samples removed) and hypolimnia (mixing dates and polymictic lake samples included). A negative ratio of CoV indicates that a clade was more variable when mixed samples were included, and a positive ratio of CoV indicates that a clade was less variable when mixed samples were included. Clades of gamI and *Desulfobulbaceae* were less variable in mixed samples, while *Desulfobulbus* and *Deltaproteobacteria* were more variable in mixed samples.
***
```{r, PCoA:hypolimnia2007, echo=FALSE, warning=FALSE, message=FALSE}
#Make table of just samples from 2007 at the clade level
clade_table07 <- year_subset("07", clade_table)

#Make table of 2007 hypolimnion samples
all.hypo <- bog_subset("..H", clade_table07)

#Calculate distance matrix between samples using Bray-Curtis Similarity
distance <- vegdist(t(all.hypo), method = "bray")
#Label each point by its sampling location
lakes <- c("CB", "FB", "WS", "NS", "TB", "SS", "HK", "MA")
groups <- factor(substr(colnames(all.hypo), start = 1, stop = 2), levels = lakes)
#Run PCoA
pcoa <- betadisper(distance, groups)
#Extract scores for plotting
coord <- scores(pcoa)

#Make a vector to label each point by its mixing regime
regime <- c()
regime[which(groups == "CB" | groups == "FB" | groups == "WS")] <- "polymictic"
regime[which(groups == "NS" | groups == "TB" | groups == "SS")] <- "dimictic"
regime[which(groups == "HK" | groups == "MA")] <- "meromictic"

#Make dataframe for plotting
plot.pcoa <- data.frame(groups, coord$sites, regime)
colnames(plot.pcoa) <- c("Lake", "PCoA1", "PCoA2", "Regime")
ggplot(data=plot.pcoa, aes(x=PCoA1, y=PCoA2, colour=Lake, shape = Regime)) + geom_point(size=4) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 15, vjust=.7), axis.text.y = element_text(colour="black", size=12)) + scale_colour_brewer(palette = "Dark2")
```

####Figure S6a. Principle coordinates analysis of hypolimnia in all lakes. The color of each point indicates which lake it was sampled from, and the shape of each point indicates the mixing regime of that lake. Samples cluster by mixing regime, as well as by lake. Meromictic samples in particular are tightly clustered. 
***
```{r, PCoA:dispersion, echo=FALSE}
#Plot dispersion of each lakes' cluster.
boxplot(pcoa)
#Optional: run significance testing on clustering by lake. Takes a long time and will print straight to the markdown document.
#anosim(t(all.hypo), groups, permutations = 999, distance = "bray")
```

####Figure S6b. Distance from the centroid was calculated for each lake as a measure of dispersion. Lakes are arranged by order of increasing depth from left to right. Meromictic hypolimnia (MA and HK) are observed to have the lowest levels of dispersion, indicating a more stable community composition on long time scales. Polymictic hypolimnia (CB, FB, and WS) have increasing dispersion with depth. NS and TB, both dimictic have a wide range of dispersion, while dimictic SS appears more similar in dispersion to meromictic lakes.
***
```{r, PCoA:hypolimnia+years, echo=FALSE, warning=FALSE, message=FALSE}
#Plot PCoA of hypolimnia samples of each lake over all years of sampling available. The method is the same as above. This analysis is performed on lakes with multiple years of sampling: CB, TB, NS, SS, and MA. An example anosim() signficance test for clustering by year is included with TB: this takes a long time to run and prints directly to the markdown document. When this command was run for all lakes, all were significant at p=0.0001. 

TB <- bog_subset("TB.", clade_table)

distance <- vegdist(t(TB), method = "bray")
groups <- factor(substr(colnames(TB), start = 9, stop = 10), levels = c("05", "07", "08", "09"))

pcoa <- betadisper(distance, groups)
coord <- scores(pcoa)

layer <- factor(substr(colnames(TB), start=3, stop=3), levels = c("E", "H"))
plot.pcoa <- data.frame(groups, coord$sites, layer)
colnames(plot.pcoa) <- c("Year", "PCoA1", "PCoA2", "Layer")

ggplot(data=plot.pcoa, aes(x=PCoA1, y=PCoA2, colour=Year, shape=Layer)) + geom_point(size=3) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 15, vjust=.7), axis.text.y = element_text(colour="black", size=12)) + scale_colour_brewer(palette = "Dark2") + labs(title = "Trout Bog")
#anosim(t(TB), groups, permutations = 999, distance = "bray")
#TBE <- bog_subset("TBE", clade_table)
#group2 <- factor(substr(colnames(TBE), start = 9, stop = 10), levels = c("05", "07", "08", "09"))
#anosim(t(TBE), group2, permutations = 999, distance = "bray")

############
MA <- bog_subset("MA.", clade_table)

distance <- vegdist(t(MA), method = "bray")
groups <- factor(substr(colnames(MA), start = 9, stop = 10), levels = c("05", "07", "08", "09"))

pcoa <- betadisper(distance, groups)
coord <- scores(pcoa)

layer <- factor(substr(colnames(MA), start=3, stop=3), levels = c("E", "H"))
plot.pcoa <- data.frame(groups, coord$sites, layer)
colnames(plot.pcoa) <- c("Year", "PCoA1", "PCoA2", "Layer")

ggplot(data=plot.pcoa, aes(x=PCoA1, y=PCoA2, colour=Year, shape=Layer)) + geom_point(size=3) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 15, vjust=.7), axis.text.y = element_text(colour="black", size=12)) + scale_colour_brewer(palette = "Dark2")  + labs(title = "Mary Lake")

###########
CB <- bog_subset("CB.", clade_table)

groups <- factor(substr(colnames(CB), start = 9, stop = 10), levels = c("07", "09"))
layer <- factor(substr(colnames(CB[,which(is.na(groups) == F)]), start=3, stop=3), levels = c("E", "H"))
distance <- vegdist(t(CB[,which(is.na(groups) == F)]), method = "bray")
groups <- groups[which(is.na(groups) == F)]


pcoa <- betadisper(distance, groups)
coord <- scores(pcoa)

plot.pcoa <- data.frame(groups, coord$sites, layer)
colnames(plot.pcoa) <- c("Year", "PCoA1", "PCoA2", "Layer")

ggplot(data=plot.pcoa, aes(x=PCoA1, y=PCoA2, colour=Year, shape=Layer)) + geom_point(size=3) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 15, vjust=.7), axis.text.y = element_text(colour="black", size=12)) + scale_colour_brewer(palette = "Dark2")  + labs(title = "Crystal Bog")

############
NS <- bog_subset("NS.", clade_table)

groups <- factor(substr(colnames(NS), start = 9, stop = 10), levels = c("07", "08", "09"))
distance <- vegdist(t(NS[,which(is.na(groups) == F)]), method = "bray")
layer <- factor(substr(colnames(NS[,which(is.na(groups) == F)]), start=3, stop=3), levels = c("E", "H"))
groups <- groups[which(is.na(groups) == F)]

pcoa <- betadisper(distance, groups)
coord <- scores(pcoa)


plot.pcoa <- data.frame(groups, coord$sites, layer)
colnames(plot.pcoa) <- c("Year", "PCoA1", "PCoA2", "Layer")

ggplot(data=plot.pcoa, aes(x=PCoA1, y=PCoA2, colour=Year, shape=Layer)) + geom_point(size=3) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 15, vjust=.7), axis.text.y = element_text(colour="black", size=12)) + scale_colour_brewer(palette = "Dark2")  + labs(title = "North Sparkling Bog")

##########
SS <- bog_subset("SS.", clade_table)

distance <- vegdist(t(SS), method = "bray")
groups <- factor(substr(colnames(SS), start = 9, stop = 10), levels = c("07", "08", "09"))

pcoa <- betadisper(distance, groups)
coord <- scores(pcoa)

layer <- factor(substr(colnames(SS), start=3, stop=3), levels = c("E", "H"))
plot.pcoa <- data.frame(groups, coord$sites, layer)
colnames(plot.pcoa) <- c("Year", "PCoA1", "PCoA2", "Layer")

ggplot(data=plot.pcoa, aes(x=PCoA1, y=PCoA2, colour=Year, shape=Layer)) + geom_point(size=3) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(hjust = 1, size = 12, colour = "black"), axis.title = element_text(size = 15, vjust=.7), axis.text.y = element_text(colour="black", size=12)) + scale_colour_brewer(palette = "Dark2")  + labs(title = "South Sparkling Bog")
```

####Figure S7. Principle coordinates analysis of epilimnion and hypolimnion samples over four years in all lakes. The shape of each point indicates whether it was collected from the epilimnion or hypolimnion, and the color indicates the year in which it was collected. Epilimnion samples look similar each year, while hypolimnion samples cluster by year. Mary Lake hypolimnion samples are highly similar each year, while Crystal Bog hypolimnion samples are more similar to epilimnion samples. However, all lakes and layers showed significant clustering by year (p=0.0001) using an analysis of similarity test (anosim()).
***

```{r, Phenology, echo=FALSE, warning=FALSE, message=FALSE}
#Plot the phenological trend in similarity between dimictic and meromictic lakes. Trout Bog vs Mary Lake, 2007 is included in the main text of the paper. Below are phenologies between Mary Lake and other dimictic lakes and years.

#Identify mixing dates
metaNSH <- metadata[which(metalakes == "NSH" & metayears == "08"), c(1,2,4)]
metaNSH <- dcast(metaNSH, Sample_Name~Depth, fun.aggregate=mean)
NSHmixes <- metaNSH$Sample_Name[which(metaNSH$"0.5" - metaNSH$"4" < 1)]

#Select the data of interest from the clade_table
bog1 <- "NSH"
bog2 <- "MAH"
table <- year_subset("08", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

#Calculate Bray-Curtis Similarity between every dimictic sample and meromictic sample, then average by dimictic sample
mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    #Subtract from 1 to convert dissimilarity to similarity
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}

#Make dataframe for plotting
dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + geom_vline(xintercept = as.numeric(extract_date(NSHmixes)), linetype = "dashed", colour="black") + labs(y = "Bray-Curtis Similarity", title="North Sparkling vs Mary, 2008") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

#####
#Repeat

metaNSH <- metadata[which(metalakes == "NSH" & metayears == "07"), c(1,2,4)]
metaNSH <- dcast(metaNSH, Sample_Name~Depth, fun.aggregate=mean)
NSHmixes <- metaNSH$Sample_Name[which(metaNSH$"0.5" - metaNSH$"4" < 1)]

bog1 <- "NSH"
bog2 <- "MAH"
table <- year_subset("07", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}

dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + geom_vline(xintercept = as.numeric(extract_date(NSHmixes)), linetype = "dashed", colour="black") + labs(y = "Bray-Curtis Similarity", title="North Sparkling vs Mary, 2007") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

######

metaNSH <- metadata[which(metalakes == "NSH" & metayears == "09"), c(1,2,4)]
metaNSH <- dcast(metaNSH, Sample_Name~Depth, fun.aggregate=mean)
NSHmixes <- metaNSH$Sample_Name[which(metaNSH$"0.5" - metaNSH$"4" < 1)]

bog1 <- "NSH"
bog2 <- "MAH"
table <- year_subset("09", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}
#Only mix is in May when there is no sampling - not plotting for this graph
dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + labs(y = "Bray-Curtis Similarity", title="North Sparkling vs Mary, 2009") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

#####
metaSSH <- metadata[which(metalakes == "SSH" & metayears == "08"), c(1,2,4)]
metaSSH <- dcast(metaSSH, Sample_Name~Depth, fun.aggregate=mean)
SSHmixes <- metaSSH$Sample_Name[which(metaSSH$"0.5" - metaSSH$"4" < 1)]

bog1 <- "SSH"
bog2 <- "MAH"
table <- year_subset("08", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}

dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + geom_vline(xintercept = as.numeric(extract_date(SSHmixes)), linetype = "dashed", colour="black") + labs(y = "Bray-Curtis Similarity", title="South Sparkling vs Mary, 2008") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

#####
metaSSH <- metadata[which(metalakes == "SSH" & metayears == "07"), c(1,2,4)]
metaSSH <- dcast(metaSSH, Sample_Name~Depth, fun.aggregate=mean)
SSHmixes <- metaSSH$Sample_Name[which(metaSSH$"0.5" - metaSSH$"4" < 1)]

bog1 <- "SSH"
bog2 <- "MAH"
table <- year_subset("07", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}

dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + geom_vline(xintercept = as.numeric(extract_date(SSHmixes)), linetype = "dashed", colour="black") + labs(y = "Bray-Curtis Similarity", title="South Sparkling vs Mary, 2007") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

#####
metaSSH <- metadata[which(metalakes == "SSH" & metayears == "09"), c(1,2,4)]
metaSSH <- dcast(metaSSH, Sample_Name~Depth, fun.aggregate=mean)
SSHmixes <- metaSSH$Sample_Name[which(metaSSH$"0.5" - metaSSH$"4" < 1)]

bog1 <- "SSH"
bog2 <- "MAH"
table <- year_subset("09", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}

dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + geom_vline(xintercept = as.numeric(extract_date(SSHmixes)), linetype = "dashed", colour="black") + labs(y = "Bray-Curtis Similarity", title="South Sparkling vs Mary, 2009") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

######
metaTBH <- metadata[which(metalakes == "TBH" & metayears == "08"), c(1,2,4)]
metaTBH <- dcast(metaTBH, Sample_Name~Depth, fun.aggregate=mean)
TBHmixes <- metaTBH$Sample_Name[which(metaTBH$"0.5" - metaTBH$"4" < 1)]

bog1 <- "TBH"
bog2 <- "MAH"
table <- year_subset("08", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}

dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + geom_vline(xintercept = as.numeric(extract_date(TBHmixes)), linetype = "dashed", colour="black") + labs(y = "Bray-Curtis Similarity", title="Trout Bog vs Mary, 2008") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

######
metaTBH <- metadata[which(metalakes == "TBH" & metayears == "05"), c(1,2,4)]
metaTBH <- dcast(metaTBH, Sample_Name~Depth, fun.aggregate=mean)
TBHmixes <- metaTBH$Sample_Name[which(metaTBH$"0.5" - metaTBH$"4" < 1)]

bog1 <- "TBH"
bog2 <- "MAH"
table <- year_subset("05", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}

dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + geom_vline(xintercept = as.numeric(extract_date(TBHmixes)), linetype = "dashed", colour="black") + labs(y = "Bray-Curtis Similarity", title="Trout Bog vs Mary, 2005") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

######
metaTBH <- metadata[which(metalakes == "TBH" & metayears == "09"), c(1,2,4)]
metaTBH <- dcast(metaTBH, Sample_Name~Depth, fun.aggregate=mean)
TBHmixes <- metaTBH$Sample_Name[which(metaTBH$"0.5" - metaTBH$"4" < 1)]

bog1 <- "TBH"
bog2 <- "MAH"
table <- year_subset("09", clade_table)
query <- bog_subset(bog1, table)
database <- bog_subset(bog2, table)

mean.bc <- c()
for(i in 1:dim(query)[2]){
  bc.dis <- c()
  for(j in 1:dim(database)[2]){
    test <- cbind(query[,i], database[,j])
    bc.dis[j] <- 1- vegdist(t(test), method="bray")
  }
  mean.bc[i] <- mean(bc.dis) 
}

dates <- extract_date(colnames(query))
plot.data <- data.frame(dates, mean.bc)
  colnames(plot.data) <- c("Dates", "BrayCurtis")
  ggplot(data=plot.data, aes(x=Dates, y=BrayCurtis)) + geom_line(size=1.5) + labs(y = "Bray-Curtis Similarity", title="Trout Bog vs Mary, 2009") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(axis.text.x = element_text(vjust = 1.5, size = 12, colour = "black"), axis.title.x = element_text(size = 15), axis.text.y = element_text(colour="black", size=10), axis.title.y = element_text(size = 15, vjust=.5), axis.title.y = element_text(colour="black", size=15))

```

####Figure S8. Bray-Curtis Similarity between each dimictic bog lake and Mary Lake . Each point represents the average similarity between the NSB sample taken on that date and every Mary lake sample taken that year. Dashed lines represent days when the water column was mixed, defined as less than one degree difference in temperature between 0.5 m and the maximum sampling depth.   
***
